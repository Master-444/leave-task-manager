<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave & Task Manager - Admin Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        :root {
            --primary-color: #0ea5e9;
            --primary-hover: #0284c7;
            --primary-active: #0369a1;
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --text-primary: #0c2d48;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, #06b6d4 100%);
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #06b6d4 100%);
            color: var(--white);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        header .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            top: 2px;
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        thead {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--primary-color);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--bg-primary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            width: fit-content;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .badge-info {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-color);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .alert-info {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .task-card {
            background: var(--white);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            font-size: 12px;
        }

        .email-sent-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
            border-radius: 4px;
            font-size: 12px;
        }

        .completed-section {
            background: rgba(16, 185, 129, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 18px;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>üîê Portal Login</h1>
                <p>Leave & Task Management System</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>User Type *</label>
                    <select id="userType" required>
                        <option value="">Select User Type</option>
                        <option value="Admin">Admin</option>
                        <option value="PA">Personal Assistant (PA)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User ID *</label>
                    <input type="text" id="loginUsername" placeholder="Enter your User ID" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <div id="loginAlert" class="alert"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Login</button>
            </form>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="mainApp" class="hidden">
        <header>
            <div class="container">
                <div class="header-content">
                    <h1>üìã Leave & Task Management System</h1>
                    <div class="user-info">
                        <span id="userDisplay"></span>
                        <button class="logout-btn" onclick="handleLogout()">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Alert Messages -->
            <div id="alert" class="alert"></div>

            <!-- Navigation Tabs -->
            <div class="tab-container">
                <button class="tab-btn active" data-tab="leaves">üèñÔ∏è Leave Management</button>
                <button class="tab-btn" data-tab="tasks">üìã Task Management</button>
                <button class="tab-btn" id="settingsTabBtn" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>

            <!-- LEAVE MANAGEMENT TAB -->
            <div id="leaves" class="tab-content active">
                <div class="section-title">üèñÔ∏è Leave Management System</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalLeaveRequests">0</div>
                        <div class="stat-label">Total Leave Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingLeaves">0</div>
                        <div class="stat-label">Pending Approvals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="approvedLeaves">0</div>
                        <div class="stat-label">Approved Leaves</div>
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openLeaveApplicationModal()">+ New Leave Application</button>
                    <button class="btn btn-secondary" onclick="exportLeaveData()">üì• Export Leave Report</button>
                </div>

                <div class="search-bar">
                    <select id="leaveStatusFilter" onchange="filterLeaves()" style="flex: 0 0 200px;">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Withdrawn">Withdrawn</option>
                    </select>
                    <input type="text" id="leaveSearch" class="search-input" placeholder="Search by faculty name..." onkeyup="filterLeaves()">
                </div>

                <div id="leaveRequestsTable">
                    <table>
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Leave Type</th>
                                <th>From Date</th>
                                <th>To Date</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Applied Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leaveRequestsTableBody">
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 40px;">
                    <div class="section-title">Leave Balance Overview</div>
                    <div id="leaveBalanceTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>Faculty Name</th>
                                    <th>CL Balance</th>
                                    <th>ML Balance</th>
                                    <th>EL Balance</th>
                                    <th>SL Balance</th>
                                </tr>
                            </thead>
                            <tbody id="leaveBalanceTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <div class="section-title">‚öôÔ∏è System Settings</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total System Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalFaculty">0</div>
                        <div class="stat-label">Total Faculty Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalLeaveTypes">5</div>
                        <div class="stat-label">Leave Types Configured</div>
                    </div>
                </div>

                <!-- USER ACCOUNT MANAGEMENT SECTION -->
                <div style="margin-bottom: 40px;">
                    <div class="section-title">üë§ User Account Management</div>
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openCreateUserModal()">+ Create New User</button>
                    </div>

                    <div id="userManagementTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>User Type</th>
                                    <th>Created Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openAddLeaveTypeModal()">+ Add Leave Type</button>
                </div>

                <div style="margin-bottom: 40px; border-top: 2px solid var(--border-color); padding-top: 30px;">
                    <div class="section-title">Configured Leave Types</div>
                    <div id="leaveTypesTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>Leave Type Code</th>
                                    <th>Leave Type Name</th>
                                    <th>Annual Allocation</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leaveTypesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <div class="section-title">Faculty Directory</div>
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openAddFacultyModal()">+ Add Faculty</button>
                        <button class="btn btn-secondary" onclick="exportAllFacultyLeaves()">üì• Export All Faculty Leaves</button>
                        <select id="facultyExportFilter" onchange="filterFacultyDirectory()" style="flex: 0 0 250px;">
                            <option value="">All Faculty</option>
                        </select>
                        <input type="text" id="facultySearchDir" class="search-input" placeholder="Search faculty..." onkeyup="filterFacultyDirectory()">
                    </div>
                    <div id="facultyDirectoryTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>Faculty</th>
                                    <th>CL</th>
                                    <th>ML</th>
                                    <th>EL</th>
                                    <th>SL</th>
                                    <th>On Duty</th>
                                    <th>Permissions</th>
                                    <th style="text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="facultyDirectoryTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TASK MANAGEMENT TAB -->
            <div id="tasks" class="tab-content">
                <div class="section-title">üìã Task Management</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingTasks">0</div>
                        <div class="stat-label">Pending Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedTasks">0</div>
                        <div class="stat-label">Completed Tasks</div>
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openAssignTaskModal()">+ Assign New Task</button>
                    <button class="btn btn-secondary" onclick="exportTaskData()">üì• Export Tasks</button>
                </div>

                <div class="search-bar">
                    <select id="taskStatusFilter" onchange="filterTasks()" style="flex: 0 0 200px;">
                        <option value="active">Active Tasks</option>
                        <option value="completed">Completed Tasks</option>
                        <option value="all">All Tasks</option>
                    </select>
                    <input type="text" id="taskSearch" class="search-input" placeholder="Search tasks..." onkeyup="filterTasks()">
                </div>

                <!-- Active Tasks -->
                <div id="activeTasksContainer"></div>

                <!-- Completed Tasks -->
                <div id="completedTasksContainer" class="completed-section hidden">
                    <div class="section-title">‚úÖ Completed Tasks</div>
                    <div id="completedTasksContainer2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- LEAVE APPLICATION MODAL -->
    <div id="leaveApplicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Apply for Leave</span>
                <button class="close-btn" onclick="closeModal('leaveApplicationModal')">&times;</button>
            </div>
            <form id="leaveApplicationForm" onsubmit="handleLeaveApplication(event)">
                <div class="form-group">
                    <label>Faculty Name *</label>
                    <select id="leaveApplicantName" required>
                        <option value="">Select Faculty Member</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Leave Type *</label>
                    <select id="leaveType" required>
                        <option value="">Select Leave Type</option>
                        <option value="CL">Casual Leave (CL) - 12 days</option>
                        <option value="ML">Medical Leave (ML) - 12 days</option>
                        <option value="EL">Earned Leave (EL) - 20 days</option>
                        <option value="SL">Special Leave (SL)</option>
                        <option value="OD">On Duty (OD) - As per rule</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>From Date *</label>
                        <input type="date" id="leaveFromDate" required>
                    </div>
                    <div class="form-group">
                        <label>To Date *</label>
                        <input type="date" id="leaveToDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Leave Duration *</label>
                    <select id="leaveDuration" required>
                        <option value="">Select Duration</option>
                        <option value="Full Day">Full Day</option>
                        <option value="Half Day - Forenoon">Half Day - Forenoon</option>
                        <option value="Half Day - Afternoon">Half Day - Afternoon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reason for Leave *</label>
                    <textarea id="leaveReason" rows="3" placeholder="Provide reason for leave" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leaveApplicationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Application</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LEAVE MODIFICATION MODAL -->
    <div id="leaveModificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Modify Leave Request</span>
                <button class="close-btn" onclick="closeModal('leaveModificationModal')">&times;</button>
            </div>
            <form id="leaveModificationForm" onsubmit="handleLeaveModification(event)">
                <input type="hidden" id="modifyLeaveId">
                <div class="form-group">
                    <label>Faculty Name</label>
                    <input type="text" id="modifyLeaveApplicant" readonly>
                </div>
                <div class="form-group">
                    <label>Leave Type</label>
                    <input type="text" id="modifyLeaveType" readonly>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>From Date *</label>
                        <input type="date" id="modifyLeaveFromDate" required>
                    </div>
                    <div class="form-group">
                        <label>To Date *</label>
                        <input type="date" id="modifyLeaveToDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Duration *</label>
                    <select id="modifyLeaveDuration" required>
                        <option value="Full Day">Full Day</option>
                        <option value="Half Day - Forenoon">Half Day - Forenoon</option>
                        <option value="Half Day - Afternoon">Half Day - Afternoon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reason for Leave *</label>
                    <textarea id="modifyLeaveReason" rows="3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leaveModificationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Leave Request</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD LEAVE TYPE MODAL -->
    <div id="addLeaveTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Add New Leave Type</span>
                <button class="close-btn" onclick="closeModal('addLeaveTypeModal')">&times;</button>
            </div>
            <form id="addLeaveTypeForm" onsubmit="handleAddLeaveType(event)">
                <div class="form-group">
                    <label>Leave Type Code (e.g., LWF, PT) *</label>
                    <input type="text" id="leaveTypeCode" placeholder="e.g., LWF" maxlength="5" required>
                </div>
                <div class="form-group">
                    <label>Leave Type Name *</label>
                    <input type="text" id="leaveTypeName" placeholder="e.g., Leave Without Fellowship" required>
                </div>
                <div class="form-group">
                    <label>Annual Allocation (days) *</label>
                    <input type="number" id="leaveTypeAllocation" min="0" max="365" required>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="leaveTypeCategory" required>
                        <option value="Standard">Standard</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLeaveTypeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Leave Type</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD FACULTY MODAL -->
    <div id="addFacultyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Add New Faculty Member</span>
                <button class="close-btn" onclick="closeModal('addFacultyModal')">&times;</button>
            </div>
            <form id="addFacultyForm" onsubmit="handleAddFaculty(event)">
                <div class="form-group">
                    <label>Faculty Name *</label>
                    <input type="text" id="facultyName" placeholder="Enter faculty name (e.g., Dr. John Doe)" required>
                </div>
                <div class="form-group">
                    <label>Designation *</label>
                    <input type="text" id="facultyDesignation" placeholder="e.g., Professor, Associate Professor" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Casual Leave (CL) Allocation *</label>
                        <input type="number" id="facultyCL" value="12" min="0" max="30" required>
                    </div>
                    <div class="form-group">
                        <label>Medical Leave (ML) Allocation *</label>
                        <input type="number" id="facultyML" value="12" min="0" max="30" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Earned Leave (EL) Allocation *</label>
                        <input type="number" id="facultyEL" value="20" min="0" max="30" required>
                    </div>
                    <div class="form-group">
                        <label>Special Leave (SL) Allocation *</label>
                        <input type="number" id="facultySL" value="10" min="0" max="30" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>On Duty (OD) Allocation *</label>
                    <input type="number" id="facultyOD" value="30" min="0" max="60" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addFacultyModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Faculty</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CREATE USER MODAL -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Create New User Account</span>
                <button class="close-btn" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <form id="createUserForm" onsubmit="handleCreateUser(event)">
                <div class="form-group">
                    <label>User Type *</label>
                    <select id="newUserType" required onchange="updateNewUserType()">
                        <option value="">Select User Type</option>
                        <option value="Admin">Admin</option>
                        <option value="PA">Personal Assistant (PA)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User ID *</label>
                    <input type="text" id="newUserId" placeholder="e.g., admin_user or pa_assistant" required>
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="newUserFullName" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="newUserEmail" placeholder="Enter email address" required>
                </div>
                <div id="passwordFields" style="display: none;">
                    <div class="form-group">
                        <label>Password *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" id="newUserPassword" placeholder="Enter password" required>
                            <button type="button" class="btn btn-secondary btn-small" onclick="generatePassword()">üîê Generate</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" id="newUserPasswordConfirm" placeholder="Confirm password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User & Send Credentials</button>
                </div>
            </form>
        </div>
    </div>

    <!-- RESET PASSWORD MODAL -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Reset User Password</span>
                <button class="close-btn" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                <input type="hidden" id="resetUserIdInput">
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="resetUserId" readonly>
                </div>
                <div class="form-group">
                    <label>New Password *</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" id="resetNewPassword" placeholder="Enter new password" required>
                        <button type="button" class="btn btn-secondary btn-small" onclick="generateResetPassword()">üîê Generate</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" id="resetNewPasswordConfirm" placeholder="Confirm password" required>
                </div>
                <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid var(--warning-color);">
                    <p style="font-size: 13px; color: var(--warning-color); margin: 0;">
                        <strong>‚ö†Ô∏è Note:</strong> A temporary password email will be sent to the user's registered email address (simulated).
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reset Password & Send Email</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ASSIGN TASK MODAL -->
    <div id="assignTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Assign New Task</span>
                <button class="close-btn" onclick="closeModal('assignTaskModal')">&times;</button>
            </div>
            <form id="assignTaskForm" onsubmit="handleAssignTask(event)">
                <div class="form-group">
                    <label>Task Title *</label>
                    <input type="text" id="taskTitle" placeholder="Enter task title" required>
                </div>
                <div class="form-group">
                    <label>Task Description *</label>
                    <textarea id="taskDescription" rows="3" placeholder="Detailed task description" required></textarea>
                </div>
                <div class="form-group">
                    <label>Assign To *</label>
                    <select id="taskAssignee" onchange="updateAssigneeDropdown()" required>
                        <option value="">Select Assignee Type</option>
                        <option value="Faculty">Faculty Member</option>
                        <option value="PA">Personal Assistant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Assignee *</label>
                    <select id="taskAssigneeSelect" required style="display: none;">
                        <option value="">Select Assignee</option>
                    </select>
                    <input type="text" id="taskAssigneeEmail" placeholder="Enter email address" required style="display: none;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Priority *</label>
                        <select id="taskPriority" required>
                            <option value="">Select Priority</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Date *</label>
                        <input type="date" id="taskDueDate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignTaskModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Task & Send Email</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Authentication Data
        // Fixed admin login. All PA users will be created via Settings.
        const credentials = {
            admin: { username: 'admin', password: 'master@5144', role: 'Admin' }
        };

        let currentUser = null;

        // Data Storage
        const state = {
            leaves: [],
            tasks: [],
            users: [
                {
                    userId: 'admin',
                    userType: 'Admin',
                    fullName: 'Administrator',
                    email: 'admin@institution.edu',
                    createdDate: '2024-01-01',
                    status: 'Active'
                }
            ],
            nextLeaveId: 1,
            nextTaskId: 1
        };

        // Leave Rules
        const leaveRules = {
            default: { CL: 12, ML: 12, EL: 20, SL: 10 }
        };

        // Persistence helpers
        function saveAppState() {
            try {
                localStorage.setItem('ltm_state', JSON.stringify({
                    leaves: state.leaves,
                    tasks: state.tasks,
                    users: state.users,
                    nextLeaveId: state.nextLeaveId,
                    nextTaskId: state.nextTaskId
                    credentials: credentials
                }));
                localStorage.setItem('ltm_facultyBalances', JSON.stringify(window.facultyBalances || []));
            } catch (e) {
                console.error('Error saving state', e);
            }
        }

        function loadAppState() {
            try {
                const saved = localStorage.getItem('ltm_state');
                const savedFaculty = localStorage.getItem('ltm_facultyBalances');

                if (saved) {
                    const parsed = JSON.parse(saved);
                    state.leaves = parsed.leaves || [];
                    state.tasks = parsed.tasks || [];
                    state.users = parsed.users || state.users;
                    state.nextLeaveId = parsed.nextLeaveId || 1;
                    state.nextTaskId = parsed.nextTaskId || 1;
                    if (parsed.credentials) { Object.assign(credentials, parsed.credentials); }
                }

                if (savedFaculty) {
                    window.facultyBalances = JSON.parse(savedFaculty);
                } else {
                    window.facultyBalances = window.facultyBalances || [];
                }
            } catch (e) {
                console.error('Error loading saved state', e);
            }
        }

        // IndexedDB fallback for Perplexity environment
function saveToIndexedDB(stateData) {
  const request = indexedDB.open('LeaveTaskManager', 1);
  request.onupgradeneeded = function(event) {
    const db = event.target.result;
    if (!db.objectStoreNames.contains('appState')) {
      db.createObjectStore('appState', { keyPath: 'key' });
    }
  };
  request.onsuccess = function(event) {
    const db = event.target.result;
    const transaction = db.transaction(['appState'], 'readwrite');
    const store = transaction.objectStore('appState');
    store.put({ key: 'state', data: stateData });
  };
}

function loadFromIndexedDB() {
  const request = indexedDB.open('LeaveTaskManager', 1);
  request.onsuccess = function(event) {
    const db = event.target.result;
    const transaction = db.transaction(['appState'], 'readonly');
    const store = transaction.objectStore('appState');
    const dataRequest = store.get('state');
    dataRequest.onsuccess = function() {
      if (dataRequest.result && dataRequest.result.data) {
        const data = dataRequest.result.data;
        state.leaves = data.leaves || [];
        state.tasks = data.tasks || [];
        state.users = data.users || state.users;
        state.nextLeaveId = data.nextLeaveId || 1;
        state.nextTaskId = data.nextTaskId || 1;
        Object.assign(credentials, data.credentials || {});
        window.facultyBalances = data.facultyBalances || [];
      }
    };
  };
}

        // Login Handler
        function handleLogin(event) {
            event.preventDefault();
            const userType = document.getElementById('userType').value;
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const credKey = username.toLowerCase();
            const cred = credentials[credKey];

            if (cred && cred.role === userType && cred.username === username && cred.password === password) {
                currentUser = { username, role: userType };
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userDisplay').textContent = `${userType} - ${username}`;

                loadAppState();
                initializeData();
                controlPAAccess();
                renderLeaves();
                renderTasks();
                showAlert('‚úÖ Login successful!', 'success');
            } else {
                showLoginAlert('Invalid credentials!', 'danger');
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('userType').value = '';
            showLoginAlert('Logged out successfully!', 'success');
        }

        function showLoginAlert(message, type) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = message;
            alert.className = `alert show alert-${type}`;
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        // User Account Management Functions
        function openCreateUserModal() {
            document.getElementById('createUserForm').reset();
            document.getElementById('passwordFields').style.display = 'none';
            document.getElementById('createUserModal').classList.add('active');
        }

        function updateNewUserType() {
            const userType = document.getElementById('newUserType').value;
            const passwordFields = document.getElementById('passwordFields');
            if (userType) {
                passwordFields.style.display = 'block';
            } else {
                passwordFields.style.display = 'none';
            }
        }

        function generatePassword() {
            const length = 12;
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('newUserPassword').value = password;
            document.getElementById('newUserPasswordConfirm').value = password;
        }

        function generateResetPassword() {
            const length = 12;
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('resetNewPassword').value = password;
            document.getElementById('resetNewPasswordConfirm').value = password;
        }

        function handleCreateUser(event) {
            event.preventDefault();
            const userId = document.getElementById('newUserId').value.trim();
            const userType = document.getElementById('newUserType').value;
            const fullName = document.getElementById('newUserFullName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const passwordConfirm = document.getElementById('newUserPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showAlert('Passwords do not match!', 'danger');
                return;
            }

            if (password.length < 8) {
                showAlert('Password must be at least 8 characters long!', 'danger');
                return;
            }

            if (state.users.some(u => u.userId.toLowerCase() === userId.toLowerCase())) {
                showAlert('User ID already exists!', 'danger');
                return;
            }

            const newUser = {
                userId: userId,
                userType: userType,
                fullName: fullName,
                email: email,
                createdDate: new Date().toISOString().split('T')[0],
                status: 'Active'
            };

            state.users.push(newUser);

            credentials[userId.toLowerCase()] = {
                username: userId,
                password: password,
                role: userType
            };

            saveAppState();
            closeModal('createUserModal');
            renderUserManagement();
            showAlert(`‚úÖ User "${userId}" created successfully!\nüìß Credentials email sent to ${email}`, 'success');
        }

        function openResetPasswordModal(userId) {
            const user = state.users.find(u => u.userId === userId);
            if (user) {
                document.getElementById('resetUserIdInput').value = userId;
                document.getElementById('resetUserId').value = userId;
                document.getElementById('resetNewPassword').value = '';
                document.getElementById('resetNewPasswordConfirm').value = '';
                document.getElementById('resetPasswordModal').classList.add('active');
            }
        }

        function handleResetPassword(event) {
            event.preventDefault();
            const userId = document.getElementById('resetUserIdInput').value;
            const newPassword = document.getElementById('resetNewPassword').value;
            const newPasswordConfirm = document.getElementById('resetNewPasswordConfirm').value;

            if (newPassword !== newPasswordConfirm) {
                showAlert('Passwords do not match!', 'danger');
                return;
            }

            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters long!', 'danger');
                return;
            }

            if (credentials[userId.toLowerCase()]) {
                credentials[userId.toLowerCase()].password = newPassword;
            }

            const user = state.users.find(u => u.userId === userId);
            if (user) {
                saveAppState();
                closeModal('resetPasswordModal');
                renderUserManagement();
                showAlert(`‚úÖ Password reset successfully!\nüìß Temporary password email sent to ${user.email}`, 'success');
            }
        }

        function deleteUser(userId) {
            if (!currentUser || userId === currentUser.username) {
                showAlert('Cannot delete the currently logged-in user!', 'danger');
                return;
            }

            if (confirm(`Are you sure you want to delete user "${userId}"? This action cannot be undone.`)) {
                state.users = state.users.filter(u => u.userId !== userId);
                delete credentials[userId.toLowerCase()];
                saveAppState();
                renderUserManagement();
                showAlert(`User "${userId}" deleted successfully!`, 'success');
            }
        }

        function renderUserManagement() {
            const tbody = document.getElementById('userManagementTableBody');
            tbody.innerHTML = '';

            state.users.forEach(user => {
                const isCurrentUser = currentUser && user.userId === currentUser.username;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${user.userId}</strong></td>
                    <td><span class="badge badge-info">${user.userType}</span></td>
                    <td>${new Date(user.createdDate).toLocaleDateString()}</td>
                    <td><span class="badge badge-success">${user.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-warning" onclick="openResetPasswordModal('${user.userId}')">üîê Reset Password</button>
                            ${!isCurrentUser ? `<button class="btn btn-small btn-danger" onclick="deleteUser('${user.userId}')">üóëÔ∏è Delete</button>` : '<span style="color: var(--text-secondary); font-size: 12px;">Current User</span>'}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('totalUsers').textContent = state.users.length;
        }

        // Leave Types Management
        window.leaveTypes = [
            { code: 'CL', name: 'Casual Leave', allocation: 12, type: 'Standard' },
            { code: 'ML', name: 'Medical Leave', allocation: 12, type: 'Standard' },
            { code: 'EL', name: 'Earned Leave', allocation: 20, type: 'Standard' },
            { code: 'SL', name: 'Special Leave', allocation: 10, type: 'Standard' },
            { code: 'OD', name: 'On Duty', allocation: 30, type: 'Standard' }
        ];

        // Initialize Sample Data (now only ensures arrays exist; no dummy faculty)
        function initializeData() {
            if (!state.leaves) state.leaves = [];
            if (!state.tasks) state.tasks = [];
            if (!state.users || state.users.length === 0) {
                state.users = [
                    {
                        userId: 'admin',
                        userType: 'Admin',
                        fullName: 'Administrator',
                        email: 'admin@institution.edu',
                        createdDate: '2024-01-01',
                        status: 'Active'
                    }
                ];
            }

            if (!window.facultyBalances) {
                window.facultyBalances = [];
            }

            // Initialize dropdowns based on current faculty list
            updateFacultyDropdowns();
        }

        // Tab Navigation with Role-Based Access
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                const tabId = e.target.dataset.tab;
                document.getElementById(tabId).classList.add('active');

                if (tabId === 'leaves') {
                    renderLeaves();
                } else if (tabId === 'tasks') {
                    renderTasks();
                } else if (tabId === 'settings') {
                    renderSettings();
                }
            });
        });

        // Control PA access
        function controlPAAccess() {
            const settingsBtn = document.getElementById('settingsTabBtn');
            const leavesBtn = document.querySelectorAll('[data-tab="leaves"]')[0];
            
            if (currentUser.role === 'PA') {
                leavesBtn.style.display = 'none';
                settingsBtn.style.display = 'none';
                document.querySelectorAll('[data-tab="tasks"]')[0].click();
            } else {
                leavesBtn.style.display = 'block';
                settingsBtn.style.display = 'block';
            }
        }

        // Modal Functions
        function openAddLeaveTypeModal() {
            document.getElementById('addLeaveTypeModal').classList.add('active');
        }

        function openLeaveApplicationModal() {
            document.getElementById('leaveApplicationModal').classList.add('active');
        }

        function openLeaveModificationModal(leaveId) {
            const leave = state.leaves.find(l => l.id === leaveId);
            if (leave) {
                document.getElementById('modifyLeaveId').value = leaveId;
                document.getElementById('modifyLeaveApplicant').value = leave.applicant;
                document.getElementById('modifyLeaveType').value = leave.leaveType;
                document.getElementById('modifyLeaveFromDate').value = leave.fromDate;
                document.getElementById('modifyLeaveToDate').value = leave.toDate;
                document.getElementById('modifyLeaveDuration').value = leave.duration;
                document.getElementById('modifyLeaveReason').value = leave.reason;
                document.getElementById('leaveModificationModal').classList.add('active');
            }
        }

        function openAssignTaskModal() {
            document.getElementById('assignTaskModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.getElementById(modalId).querySelector('form');
            if (form) form.reset();
        }

        // Alert Function
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert show alert-${type}`;
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        // Leave Management Functions
        function handleLeaveApplication(event) {
            event.preventDefault();
            const leave = {
                id: state.nextLeaveId++,
                applicant: document.getElementById('leaveApplicantName').value,
                leaveType: document.getElementById('leaveType').value,
                fromDate: document.getElementById('leaveFromDate').value,
                toDate: document.getElementById('leaveToDate').value,
                duration: document.getElementById('leaveDuration').value,
                reason: document.getElementById('leaveReason').value,
                status: 'Pending',
                appliedDate: new Date().toISOString().split('T')[0],
                modifiedCount: 0
            };

            state.leaves.push(leave);
            saveAppState();
            closeModal('leaveApplicationModal');
            renderLeaves();
            showAlert('Leave application submitted successfully!', 'success');
        }

        function handleLeaveModification(event) {
            event.preventDefault();
            const leaveId = parseInt(document.getElementById('modifyLeaveId').value);
            const leave = state.leaves.find(l => l.id === leaveId);

            if (leave && leave.status === 'Pending') {
                leave.fromDate = document.getElementById('modifyLeaveFromDate').value;
                leave.toDate = document.getElementById('modifyLeaveToDate').value;
                leave.duration = document.getElementById('modifyLeaveDuration').value;
                leave.reason = document.getElementById('modifyLeaveReason').value;
                leave.modifiedCount = (leave.modifiedCount || 0) + 1;
                leave.lastModifiedDate = new Date().toISOString().split('T')[0];

                saveAppState();
                closeModal('leaveModificationModal');
                renderLeaves();
                showAlert('Leave request updated successfully!', 'success');
            } else {
                showAlert('Only pending leaves can be modified!', 'danger');
            }
        }

        function withdrawLeave(leaveId) {
            const leave = state.leaves.find(l => l.id === leaveId);
            if (leave && leave.status === 'Pending') {
                if (confirm('Are you sure you want to withdraw this leave request?')) {
                    leave.status = 'Withdrawn';
                    leave.withdrawnDate = new Date().toISOString().split('T')[0];
                    saveAppState();
                    renderLeaves();
                    showAlert('Leave request withdrawn!', 'success');
                }
            } else {
                showAlert('Only pending leaves can be withdrawn!', 'danger');
            }
        }

        function approveLeave(leaveId) {
            const leave = state.leaves.find(l => l.id === leaveId);
            if (leave) {
                leave.status = 'Approved';
                leave.approvalDate = new Date().toISOString().split('T')[0];

                const balance = window.facultyBalances.find(b => b.name === leave.applicant);
                if (balance) {
                    const days = leave.duration.includes('Half') ? 0.5 :
                        Math.ceil((new Date(leave.toDate) - new Date(leave.fromDate)) / (1000 * 60 * 60 * 24)) + 1;

                    if (leave.leaveType === 'CL') balance.CL -= days;
                    else if (leave.leaveType === 'ML') balance.ML -= days;
                    else if (leave.leaveType === 'EL') balance.EL -= days;
                    else if (leave.leaveType === 'SL') balance.SL -= days;
                }

                saveAppState();
                renderLeaves();
                showAlert('Leave approved successfully!', 'success');
            }
        }

        function rejectLeave(leaveId) {
            const leave = state.leaves.find(l => l.id === leaveId);
            if (leave) {
                leave.status = 'Rejected';
                leave.rejectionDate = new Date().toISOString().split('T')[0];
                saveAppState();
                renderLeaves();
                showAlert('Leave rejected!', 'success');
            }
        }

        function renderLeaves() {
            const tbody = document.getElementById('leaveRequestsTableBody');
            const statusFilter = document.getElementById('leaveStatusFilter').value;
            const searchTerm = document.getElementById('leaveSearch').value.toLowerCase();

            let filtered = state.leaves;

            if (statusFilter) {
                filtered = filtered.filter(l => l.status === statusFilter);
            }

            filtered = filtered.filter(l => l.applicant.toLowerCase().includes(searchTerm));

            tbody.innerHTML = '';
            filtered.forEach(leave => {
                const days = leave.duration.includes('Half') ? '0.5' :
                    Math.ceil((new Date(leave.toDate) - new Date(leave.fromDate)) / (1000 * 60 * 60 * 24)) + 1;
                const statusColor = leave.status === 'Approved' ? 'success' :
                    leave.status === 'Rejected' ? 'danger' :
                    leave.status === 'Withdrawn' ? 'warning' : 'warning';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${leave.applicant}</td>
                    <td>${leave.leaveType}</td>
                    <td>${new Date(leave.fromDate).toLocaleDateString()}</td>
                    <td>${new Date(leave.toDate).toLocaleDateString()}</td>
                    <td>${days} days (${leave.duration})</td>
                    <td><span class="badge badge-${statusColor}">${leave.status}</span></td>
                    <td>${new Date(leave.appliedDate).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            ${leave.status === 'Pending' ? `
                                <button class="btn btn-small btn-success" onclick="approveLeave(${leave.id})">Approve</button>
                                <button class="btn btn-small btn-danger" onclick="rejectLeave(${leave.id})">Reject</button>
                                <button class="btn btn-small btn-warning" onclick="openLeaveModificationModal(${leave.id})">Modify</button>
                                <button class="btn btn-small btn-secondary" onclick="withdrawLeave(${leave.id})">Withdraw</button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">No leave requests found</td></tr>';
            }

            document.getElementById('totalLeaveRequests').textContent = state.leaves.length;
            document.getElementById('pendingLeaves').textContent = state.leaves.filter(l => l.status === 'Pending').length;
            document.getElementById('approvedLeaves').textContent = state.leaves.filter(l => l.status === 'Approved').length;

            renderLeaveBalance();
        }

        function renderLeaveBalance() {
            const tbody = document.getElementById('leaveBalanceTableBody');
            tbody.innerHTML = '';

            window.facultyBalances.forEach(faculty => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${faculty.name}</td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.CL)}/${faculty.CLAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.ML)}/${faculty.MLAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.EL)}/${faculty.ELAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.SL)}/${faculty.SLAlloc}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterLeaves() {
            renderLeaves();
        }

        // Task Management Functions
        function handleAssignTask(event) {
            event.preventDefault();
            const assigneeType = document.getElementById('taskAssignee').value;
            let assigneeValue = '';

            if (assigneeType === 'Faculty') {
                assigneeValue = document.getElementById('taskAssigneeSelect').value;
            } else if (assigneeType === 'PA') {
                assigneeValue = document.getElementById('taskAssigneeEmail').value;
            }

            const task = {
                id: state.nextTaskId++,
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                assignedTo: assigneeType,
                assigneeName: assigneeValue,
                assigneeEmail: assigneeType === 'Faculty' ? `${assigneeValue.toLowerCase().replace(/\s+/g, '.')}@institution.edu` : assigneeValue,
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value,
                status: 'Pending',
                createdDate: new Date().toISOString().split('T')[0],
                emailSent: true,
                assignedBy: currentUser.username
            };

            state.tasks.push(task);
            saveAppState();
            closeModal('assignTaskModal');
            renderTasks();
            showAlert(`Task assigned to ${task.assigneeName} and email notification sent to ${task.assigneeEmail}!`, 'success');
        }

        function updateAssigneeDropdown() {
            const assigneeType = document.getElementById('taskAssignee').value;
            const selectDropdown = document.getElementById('taskAssigneeSelect');
            const emailInput = document.getElementById('taskAssigneeEmail');

            if (assigneeType === 'Faculty') {
                selectDropdown.style.display = 'block';
                emailInput.style.display = 'none';
                selectDropdown.required = true;
                emailInput.required = false;
            } else if (assigneeType === 'PA') {
                selectDropdown.style.display = 'none';
                emailInput.style.display = 'block';
                selectDropdown.required = false;
                emailInput.required = true;
            } else {
                selectDropdown.style.display = 'none';
                emailInput.style.display = 'none';
                selectDropdown.required = false;
                emailInput.required = false;
            }
        }

        function markTaskInProgress(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'In Progress';
                task.startedDate = new Date().toISOString().split('T')[0];
                saveAppState();
                renderTasks();
                showAlert('Task marked as in progress!', 'success');
            }
        }

        function completeTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'Completed';
                task.completedDate = new Date().toISOString().split('T')[0];
                saveAppState();
                renderTasks();
                showAlert('Task marked as completed!', 'success');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                state.tasks = state.tasks.filter(t => t.id !== taskId);
                saveAppState();
                renderTasks();
                showAlert('Task deleted!', 'success');
            }
        }

        function renderTasks() {
            const statusFilter = document.getElementById('taskStatusFilter').value;
            const searchTerm = document.getElementById('taskSearch').value.toLowerCase();

            let activeTasks = state.tasks.filter(t => t.status !== 'Completed');
            let completedTasks = state.tasks.filter(t => t.status === 'Completed');

            if (searchTerm) {
                activeTasks = activeTasks.filter(t => t.title.toLowerCase().includes(searchTerm) || t.assigneeEmail.toLowerCase().includes(searchTerm));
                completedTasks = completedTasks.filter(t => t.title.toLowerCase().includes(searchTerm) || t.assigneeEmail.toLowerCase().includes(searchTerm));
            }

            const activeContainer = document.getElementById('activeTasksContainer');
            if (statusFilter === 'completed') {
                activeContainer.innerHTML = '';
            } else {
                activeContainer.innerHTML = '<div class="section-title">Active Tasks</div>';
                if (activeTasks.length === 0) {
                    activeContainer.innerHTML += '<div class="empty-state">No active tasks</div>';
                } else {
                    activeTasks.forEach(task => {
                        const priorityColor = task.priority === 'High' ? 'danger' : task.priority === 'Medium' ? 'warning' : 'info';
                        const daysUntilDue = Math.ceil((new Date(task.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                        const isOverdue = daysUntilDue < 0;

                        const taskCard = document.createElement('div');
                        taskCard.className = 'task-card';
                        taskCard.style.borderLeftColor = isOverdue ? 'var(--danger-color)' : 'var(--primary-color)';
                        taskCard.innerHTML = `
                            <div class="task-header">
                                <div>
                                    <div class="task-title">#${task.id} - ${task.title}</div>
                                    <div class="task-meta">
                                        <span class="badge badge-${priorityColor}">${task.priority} Priority</span>
                                        <span class="badge badge-info">${task.assignedTo === 'Faculty' ? 'Faculty' : 'Personal Assistant'}</span>
                                        <span class="badge badge-success">${task.assigneeName}</span>
                                        <span class="email-sent-indicator">‚úì Email sent to ${task.assigneeEmail}</span>
                                    </div>
                                </div>
                                <span class="badge badge-${task.status === 'In Progress' ? 'warning' : 'info'}">${task.status}</span>
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">${task.description}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                Due: ${new Date(task.dueDate).toLocaleDateString()} ${isOverdue ? `<span style="color: var(--danger-color);">‚ö†Ô∏è Overdue</span>` : `(${daysUntilDue} days)`}
                            </div>
                            <div class="action-buttons">
                                ${task.status === 'Pending' ? `<button class="btn btn-small btn-warning" onclick="markTaskInProgress(${task.id})">Start Task</button>` : ''}
                                ${task.status !== 'Completed' ? `<button class="btn btn-small btn-success" onclick="completeTask(${task.id})">Mark Completed</button>` : ''}
                                <button class="btn btn-small btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                            </div>
                        `;
                        activeContainer.appendChild(taskCard);
                    });
                }
            }

            const completedContainer = document.getElementById('completedTasksContainer');
            const completedContainer2 = document.getElementById('completedTasksContainer2');

            if (completedTasks.length > 0) {
                completedContainer.classList.remove('hidden');
                completedContainer2.innerHTML = '';
                completedTasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    taskCard.style.borderLeftColor = 'var(--success-color)';
                    taskCard.style.opacity = '0.8';
                    taskCard.innerHTML = `
                        <div class="task-header">
                            <div>
                                <div class="task-title" style="text-decoration: line-through;">#${task.id} - ${task.title}</div>
                                <div class="task-meta">
                                    <span class="badge badge-success">Completed</span>
                                    <span class="badge badge-info">${task.assignedTo}</span>
                                </div>
                            </div>
                        </div>
                        <div style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">${task.description}</div>
                        <div style="font-size: 12px; color: var(--success-color);">‚úì Completed on ${new Date(task.completedDate).toLocaleDateString()}</div>
                    `;
                    completedContainer2.appendChild(taskCard);
                });
            } else {
                completedContainer.classList.add('hidden');
            }

            document.getElementById('totalTasks').textContent = state.tasks.length;
            document.getElementById('pendingTasks').textContent = activeTasks.length;
            document.getElementById('completedTasks').textContent = completedTasks.length;
        }

        function filterTasks() {
            renderTasks();
        }

        // Export Functions
        function exportLeaveData() {
            if (state.leaves.length === 0) {
                showAlert('No leave records to export! Please add leave applications first.', 'info');
                return;
            }

            const data = state.leaves.map(l => ({
                'Leave ID': l.id,
                'Faculty Name': l.applicant,
                'Leave Type': l.leaveType,
                'From Date': new Date(l.fromDate).toLocaleDateString('en-GB'),
                'To Date': new Date(l.toDate).toLocaleDateString('en-GB'),
                'Duration': l.duration,
                'Status': l.status,
                'Reason': l.reason,
                'Applied Date': new Date(l.appliedDate).toLocaleDateString('en-GB')
            }));

            exportToExcel(data, 'Leave_Report');
        }

        function exportAllFacultyLeaves() {
            const data = window.facultyBalances.map(faculty => ({
                'Faculty Name': faculty.name,
                'Designation': faculty.designation || '',
                'CL Balance': Math.max(0, faculty.CL),
                'ML Balance': Math.max(0, faculty.ML),
                'EL Balance': Math.max(0, faculty.EL),
                'SL Balance': Math.max(0, faculty.SL),
                'On Duty Balance': Math.max(0, faculty.OD),
                'Permissions Available': faculty.permissions - (faculty.permissionsUsed || 0),
                'Permissions Used': faculty.permissionsUsed || 0
            }));

            if (data.length === 0) {
                showAlert('No faculty data available!', 'danger');
                return;
            }

            exportToExcel(data, 'Faculty_Leave_Balances');
        }

        function exportIndividualFacultyLeaves(facultyName) {
            const facultyLeaves = state.leaves.filter(l => l.applicant === facultyName);
            const facultyBalance = window.facultyBalances.find(f => f.name === facultyName);

            if (!facultyBalance) {
                showAlert('Faculty not found!', 'danger');
                return;
            }

            const data = facultyLeaves.map(l => ({
                'Leave ID': l.id,
                'Leave Type': l.leaveType,
                'From Date': new Date(l.fromDate).toLocaleDateString('en-GB'),
                'To Date': new Date(l.toDate).toLocaleDateString('en-GB'),
                'Duration': l.duration,
                'Status': l.status,
                'Reason': l.reason,
                'Applied Date': new Date(l.appliedDate).toLocaleDateString('en-GB')
            }));

            data.unshift({
                'Leave ID': 'SUMMARY',
                'Leave Type': '',
                'From Date': `CL: ${facultyBalance.CL}/${facultyBalance.CLAlloc} | ML: ${facultyBalance.ML}/${facultyBalance.MLAlloc} | EL: ${facultyBalance.EL}/${facultyBalance.ELAlloc} | SL: ${facultyBalance.SL}/${facultyBalance.SLAlloc}`,
                'To Date': '',
                'Duration': '',
                'Status': 'Current Balance',
                'Reason': '',
                'Applied Date': ''
            });

            if (data.length <= 1) {
                showAlert('No leave records for this faculty.', 'info');
                return;
            }

            exportToExcel(data, `Leave_Report_${facultyName.replace(/\s+/g, '_')}`);
        }

        function exportTaskData() {
            const data = state.tasks.map(t => ({
                'Task ID': t.id,
                'Title': t.title,
                'Description': t.description,
                'Assigned To': `${t.assigneeEmail} (${t.assignedTo})`,
                'Priority': t.priority,
                'Status': t.status,
                'Due Date': new Date(t.dueDate).toLocaleDateString(),
                'Created Date': new Date(t.createdDate).toLocaleDateString(),
                'Email Sent': t.emailSent ? 'Yes' : 'No'
            }));

            exportToExcel(data, 'Task_Report');
        }

        function exportToExcel(data, filename) {
            try {
                if (!data || data.length === 0) {
                    showAlert('No data available to export!', 'warning');
                    return;
                }

                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row =>
                        headers.map(header => {
                            const value = row[header];
                            const stringValue = String(value);
                            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                                return `"${stringValue.replace(/"/g, '""')}"`;
                            }
                            return stringValue;
                        }).join(',')
                    )
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}_${timestamp}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('CSV file exported successfully! (Downloaded as .csv)', 'success');
            } catch (error) {
                showAlert('Error exporting file: ' + error.message, 'danger');
                console.error('Export error:', error);
            }
        }

        // Settings/Faculty Directory Rendering
        function renderSettings() {
            document.getElementById('totalUsers').textContent = state.users.length;
            document.getElementById('totalFaculty').textContent = window.facultyBalances.length;
            document.getElementById('totalLeaveTypes').textContent = window.leaveTypes.length;
            renderUserManagement();
            renderLeaveTypes();
            renderFacultyDirectory();
        }

        function renderLeaveTypes() {
            const tbody = document.getElementById('leaveTypesTableBody');
            tbody.innerHTML = '';

            window.leaveTypes.forEach(leaveType => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${leaveType.code}</td>
                    <td>${leaveType.name}</td>
                    <td>${leaveType.allocation} days</td>
                    <td><span class="badge badge-info">${leaveType.type}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${leaveType.type === 'Custom' ? `<button class="btn btn-small btn-danger" onclick="deleteLeaveType('${leaveType.code}')">Delete</button>` : '<span style="color: var(--text-secondary); font-size: 12px;">Default Type</span>'}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function handleAddLeaveType(event) {
            event.preventDefault();
            const newLeaveType = {
                code: document.getElementById('leaveTypeCode').value.toUpperCase(),
                name: document.getElementById('leaveTypeName').value,
                allocation: parseInt(document.getElementById('leaveTypeAllocation').value),
                type: document.getElementById('leaveTypeCategory').value
            };

            if (window.leaveTypes.some(lt => lt.code === newLeaveType.code)) {
                showAlert('Leave type code already exists!', 'danger');
                return;
            }

            window.leaveTypes.push(newLeaveType);
            closeModal('addLeaveTypeModal');
            renderSettings();
            showAlert('Leave type added successfully!', 'success');
        }

        function deleteLeaveType(code) {
            if (confirm('Are you sure you want to delete this leave type?')) {
                window.leaveTypes = window.leaveTypes.filter(lt => lt.code !== code);
                renderSettings();
                showAlert('Leave type deleted!', 'success');
            }
        }

        function renderFacultyDirectory() {
            const tbody = document.getElementById('facultyDirectoryTableBody');
            const searchTerm = document.getElementById('facultySearchDir').value.toLowerCase();
            const filterFaculty = document.getElementById('facultyExportFilter').value;

            let filtered = window.facultyBalances;

            if (filterFaculty) {
                filtered = filtered.filter(f => f.name === filterFaculty);
            }

            filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));

            tbody.innerHTML = '';
            filtered.forEach(faculty => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        ${faculty.name}<br>
                        <span style="font-size: 12px; color: var(--text-secondary);">${faculty.designation || ''}</span>
                    </td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.CL)}/${faculty.CLAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.ML)}/${faculty.MLAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.EL)}/${faculty.ELAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.SL)}/${faculty.SLAlloc}</span></td>
                    <td><span class="badge badge-info">${Math.max(0, faculty.OD)}/${faculty.ODAlloc}</span></td>
                    <td><span class="badge badge-warning">${faculty.permissions - (faculty.permissionsUsed || 0)}/2</span></td>
                    <td style="text-align: center;">
                        <div class="action-buttons" style="justify-content: center;">
                            <button class="btn btn-small btn-secondary" onclick="exportIndividualFacultyLeaves('${faculty.name}')">üì• Export</button>
                            <button class="btn btn-small btn-primary" onclick="openEditFacultyModal('${faculty.name}', '${faculty.designation}', ${faculty.CLAlloc}, ${faculty.MLAlloc}, ${faculty.ELAlloc}, ${faculty.SLAlloc}, ${faculty.ODAlloc})">‚úèÔ∏è Edit</button> <button class="btn btn-small btn-danger" onclick="deleteFaculty('${faculty.name}')">üóëÔ∏è Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateFacultyDropdowns();
        }

        function updateFacultyDropdowns() {
            const leaveApplicantSelect = document.getElementById('leaveApplicantName');
            const currentLeaveValue = leaveApplicantSelect.value;
            leaveApplicantSelect.innerHTML = '<option value="">Select Faculty Member</option>';
            window.facultyBalances.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.name;
                option.textContent = faculty.name;
                leaveApplicantSelect.appendChild(option);
            });
            leaveApplicantSelect.value = currentLeaveValue;

            const taskAssigneeSelect = document.getElementById('taskAssigneeSelect');
            const currentTaskValue = taskAssigneeSelect.value;
            taskAssigneeSelect.innerHTML = '<option value="">Select Faculty Member</option>';
            window.facultyBalances.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.name;
                option.textContent = faculty.name;
                taskAssigneeSelect.appendChild(option);
            });
            taskAssigneeSelect.value = currentTaskValue;

            const filterSelect = document.getElementById('facultyExportFilter');
            const currentFilterValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">All Faculty</option>';
            window.facultyBalances.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.name;
                option.textContent = faculty.name;
                filterSelect.appendChild(option);
            });
            filterSelect.value = currentFilterValue;
        }

        function openAddFacultyModal() {
            document.getElementById('addFacultyModal').classList.add('active');
        }

           function openEditFacultyModal(facultyName, designation, cl, ml, el, sl, od) {
      document.getElementById('editFacultyName').value = facultyName;
      document.getElementById('editFacultyDesignation').value = designation;
      document.getElementById('editFacultyCL').value = cl;
      document.getElementById('editFacultyML').value = ml;
      document.getElementById('editFacultyEL').value = el;
      document.getElementById('editFacultySL').value = sl;
      document.getElementById('editFacultyOD').value = od;
      document.getElementById('editFacultyOldName').value = facultyName;
      document.getElementById('editFacultyModal').classList.add('active');
   }

        function handleAddFaculty(event) {
            event.preventDefault();
            const facultyName = document.getElementById('facultyName').value.trim();
            const designation = document.getElementById('facultyDesignation').value.trim();

            if (window.facultyBalances.some(f => f.name.toLowerCase() === facultyName.toLowerCase())) {
                showAlert('Faculty member already exists!', 'danger');
                return;
            }

            const newFaculty = {
                name: facultyName,
                designation: designation,
                CL: parseInt(document.getElementById('facultyCL').value),
                CLAlloc: parseInt(document.getElementById('facultyCL').value),
                ML: parseInt(document.getElementById('facultyML').value),
                MLAlloc: parseInt(document.getElementById('facultyML').value),
                EL: parseInt(document.getElementById('facultyEL').value),
                ELAlloc: parseInt(document.getElementById('facultyEL').value),
                SL: parseInt(document.getElementById('facultySL').value),
                SLAlloc: parseInt(document.getElementById('facultySL').value),
                OD: parseInt(document.getElementById('facultyOD').value),
                ODAlloc: parseInt(document.getElementById('facultyOD').value),
                permissions: 2,
                permissionsUsed: 0
            };

            window.facultyBalances.push(newFaculty);
            saveAppState();
            closeModal('addFacultyModal');
            renderFacultyDirectory();
            updateFacultyDropdowns();
            showAlert(`Faculty "${facultyName}" added successfully!`, 'success');
        }

           function handleEditFaculty(oldName) {
      const facultyName = document.getElementById('editFacultyName').value.trim();
      const designation = document.getElementById('editFacultyDesignation').value.trim();
      const cl = parseInt(document.getElementById('editFacultyCL').value);
      const ml = parseInt(document.getElementById('editFacultyML').value);
      const el = parseInt(document.getElementById('editFacultyEL').value);
      const sl = parseInt(document.getElementById('editFacultySL').value);
      const od = parseInt(document.getElementById('editFacultyOD').value);

      if (window.facultyBalances.some(f => f.name.toLowerCase() === facultyName.toLowerCase() && f.name !== oldName)) {
         showAlert('Faculty name already exists!', 'danger');
         return;
      }

      const faculty = window.facultyBalances.find(f => f.name === oldName);
      if (faculty) {
         faculty.name = facultyName;
         faculty.designation = designation;
         faculty.CLAlloc = cl;
         faculty.CL = cl;
         faculty.MLAlloc = ml;
         faculty.ML = ml;
         faculty.ELAlloc = el;
         faculty.EL = el;
         faculty.SLAlloc = sl;
         faculty.SL = sl;
         faculty.ODAlloc = od;
         faculty.OD = od;
         
         saveAppState();
         closeModal('editFacultyModal');
         renderFacultyDirectory();
         updateFacultyDropdowns();
         showAlert(`Faculty "${facultyName}" updated successfully!`, 'success');
      }
   }

        function deleteFaculty(facultyName) {
            if (confirm(`Are you sure you want to delete "${facultyName}"? This will remove their leave balance record.`)) {
                window.facultyBalances = window.facultyBalances.filter(f => f.name !== facultyName);
                
                state.leaves = state.leaves.filter(l => l.applicant !== facultyName);
                state.tasks = state.tasks.filter(t => t.assigneeName !== facultyName);

                saveAppState();
                renderFacultyDirectory();
                updateFacultyDropdowns();
                renderLeaves();
                renderTasks();
                showAlert(`Faculty "${facultyName}" deleted successfully!`, 'success');
            }
        }

        function filterFacultyDirectory() {
            renderFacultyDirectory();
        }

        window.addEventListener('load', () => {
            console.log('System ready. Admin login: admin / master@5144');
        });
    </script>
</body>
</html>
